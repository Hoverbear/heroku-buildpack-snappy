#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail

# Build related variables.
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BUILDPACK_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

echo "\$ENV_DIR = $ENV_DIR"

if [[ ! -d "$CACHE_DIR/snappy" ]]; then
    mkdir -p $CACHE_DIR
    cd $CACHE_DIR
    git clone https://github.com/google/snappy
    cd snappy
    ./autogen.sh
    ./configure --prefix="$CACHE_DIR/snappy-build"
    make
    make install
fi

# Recreate if needed.
echo "export LD_LIBRARY_PATH=/app/tmp/cache/snappy-build/lib" > $BUILDPACK_DIR/export
echo "export LB_RUN_PATH=/app/tmp/cache/snappy-build/lib" >> $BUILDPACK_DIR/export

echo "\$BUILDPACK_DIR is $BUILDPACK_DIR"
echo "Contents of $BUILDPACK_DIR/export is:"
echo "$(cat $BUILDPACK_DIR/export)"

echo "$(ls -la /app/tmp/cache/snappy-build/lib)"

mkdir -p $BUILD_DIR/.profile.d
echo "export LD_LIBRARY_PATH=/app/tmp/cache/snappy-build/lib" > $BUILD_DIR/.profile.d/path.sh
echo "export LB_RUN_PATH=/app/tmp/cache/snappy-build/lib" >> $BUILD_DIR/.profile.d/path.sh
